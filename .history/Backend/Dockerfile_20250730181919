# Dockerfile para Backend Node.js (Express + Prisma)

FROM node:20-alpine

# Instala o Postgres client e server
RUN apk add --no-cache postgresql postgresql-contrib su-exec

WORKDIR /app

# Instala dependências do Node.js
COPY package*.json ./
RUN npm install --production=false

# Copia código e Prisma
COPY prisma ./prisma
RUN npx prisma generate
COPY . .

# Build do projeto
RUN npm run build

# Cria diretórios do Postgres
RUN mkdir -p /var/lib/postgresql/data && chown -R postgres:postgres /var/lib/postgresql

# Variáveis de ambiente do banco
ENV POSTGRES_USER=postgres
ENV POSTGRES_PASSWORD=postgres
ENV POSTGRES_DB=tarefix

# Script de inicialização
COPY docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

EXPOSE 3001 5432

CMD ["/docker-entrypoint.sh"]
